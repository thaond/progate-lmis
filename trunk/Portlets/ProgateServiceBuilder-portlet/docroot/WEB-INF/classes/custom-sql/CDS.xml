<?xml version="1.0" encoding="utf-8"?>
<custom-sql>
	<sql id="FinalTitleList">
        <![CDATA[
        SELECT a.*
   		FROM v_cds_performance_appraisal_final_cds_titles a
		WHERE (a.root_id=?) and (a.user_id=?)
           ]]>
	</sql>

	<sql id="SlotInformation">
        <![CDATA[
        SELECT a.*
   		FROM v_slot_information a
		WHERE (a.slot_id=?) and (a.user_id=?)
           ]]>
	</sql>

	<sql id="AllFinalCompetencies">
        <![CDATA[
        SELECT a.id, a.root_id, a.name, b.user_id,
        b.level_ranking_hash, b.level_ranking_value
   FROM cds_competencies a
   LEFT JOIN (SELECT * FROM cds_performance_appraisal_final_competencies temp
   WHERE temp.root_id = ? AND temp.user_id = ?) b
   ON a.id = b.competency_id
   WHERE a.root_id = ?
   ORDER BY a.number_order ASC
           ]]>
	</sql>

	<sql id="FinalCompetenciesByCompetencyId">
        <![CDATA[
        SELECT a.id, a.root_id, a.name, b.user_id,
        b.level_ranking_hash, b.level_ranking_value
   FROM cds_competencies a
   LEFT JOIN (SELECT * FROM cds_performance_appraisal_final_competencies temp
   WHERE temp.root_id = ? AND temp.user_id = ?) b
   ON a.id = b.competency_id
   WHERE a.root_id = ? AND a.id=?
           ]]>
	</sql>

	<sql id="FinalLevels">
        <![CDATA[
        SELECT a.id, a.competency_id, a.root_id, a.name,
 	b.user_id, b.total_level_point, b.is_passed
   FROM cds_levels a
   LEFT JOIN (SELECT * FROM cds_performance_appraisal_final_levels temp
   WHERE temp.root_id=? AND temp.user_id=?) b
   ON a.id = b.level_id
   WHERE a.competency_id=?
   ORDER BY a.number_order ASC
           ]]>
	</sql>

	<sql id="AllFinalSlots">
        <![CDATA[
         SELECT a.id, a.level_id, a.root_id, a.name, a.description,
 	b.user_id, b.rating_status, b.point_name, b.max_point_name,
 	b.point_value, b.max_point_value, b.is_passed
   FROM cds_slots a
   LEFT JOIN (SELECT * FROM cds_performance_appraisal_final_slots temp
   WHERE temp.root_id=? AND temp.user_id=?) b
   ON a.id = b.slot_id
   WHERE a.level_id=?
   ORDER BY a.number_order ASC
           ]]>
	</sql>

	<sql id="FinalSlotsPass">
        <![CDATA[
         SELECT a.id, a.level_id, a.root_id, a.name, a.description,
 	b.user_id, b.rating_status, b.point_name, b.max_point_name,
 	b.point_value, b.max_point_value, b.is_passed
   FROM cds_slots a
   JOIN (SELECT * FROM cds_performance_appraisal_final_slots temp
   WHERE temp.root_id=? AND temp.user_id=? AND temp.is_passed=true) b
   ON a.id = b.slot_id
   WHERE a.level_id=?
   ORDER BY a.number_order ASC
           ]]>
	</sql>

	<sql id="FinalSlotsFail">
        <![CDATA[
         SELECT a.id, a.level_id, a.root_id, a.name, a.description,
 	b.user_id, b.rating_status, b.point_name, b.max_point_name,
 	b.point_value, b.max_point_value, b.is_passed
   FROM cds_slots a
   JOIN (SELECT * FROM cds_performance_appraisal_final_slots temp
   WHERE temp.root_id=? AND temp.user_id=? AND temp.is_passed=false AND temp.rating_status=true) b
   ON a.id = b.slot_id
   WHERE a.level_id=?
   ORDER BY a.number_order ASC
           ]]>
	</sql>

	<sql id="FinalSlotsNotStart">
        <![CDATA[
         SELECT a.id, a.level_id, a.root_id, a.name, a.description,
 b.user_id, b.rating_status, b.point_name, b.max_point_name,
 b.point_value, b.max_point_value, b.is_passed
   FROM cds_slots a
   LEFT JOIN (SELECT * FROM cds_performance_appraisal_final_slots temp
   WHERE temp.root_id=? AND temp.user_id=? AND temp.rating_status=false) b
   ON a.id = b.slot_id
   WHERE a.level_id=? AND a.id NOT IN
(SELECT c.slot_id FROM cds_performance_appraisal_final_slots c
   WHERE c.root_id=? AND c.user_id=?)
   ORDER BY a.number_order ASC
           ]]>
	</sql>

	<sql id="PACompetencies">
        <![CDATA[
        SELECT a.*
   		FROM cds_performance_appraisal_competencies a
   		JOIN cds_competencies b ON a.competency_id = b.id
   		WHERE a.user_id = ? AND a.period_id = ?
   		ORDER BY b.number_order ASC
           ]]>
	</sql>

	<sql id="CdsPerformanceAppraisalLevels">
        <![CDATA[
        SELECT *
   		FROM cds_performance_appraisal_levels a
   		JOIN cds_levels b ON a.level_id = b.id
   		WHERE a.user_id = ? AND a.period_id = ?
   		ORDER BY b.number_order ASC
           ]]>
	</sql>

	<sql id="CdsPerformanceAppraisalSlots">
        <![CDATA[
        SELECT *
   		FROM cds_performance_appraisal_slots a
   		JOIN cds_slots b ON a.slot_id = b.id
   		WHERE a.user_id = ? AND a.period_id = ?
   		ORDER BY b.number_order ASC
           ]]>
	</sql>

	<sql id="PALevels">
        <![CDATA[
        SELECT *
   		FROM v_performance_appraisal_levels
   		WHERE user_id = ? AND period_id = ? AND competency_id = ?
   		ORDER BY number_order ASC
           ]]>
	</sql>

	<sql id="PASlots">
        <![CDATA[
        SELECT *
   		FROM v_performance_appraisal_slots
   		WHERE user_id = ? AND period_id = ? AND level_id = ?
   		ORDER BY competency_number_order, level_number_order, slot_number_order ASC
           ]]>
	</sql>

	<sql id="AllFinalSlotsNotInPASlot">
        <![CDATA[
         SELECT a.id, a.level_id, a.root_id, a.name, a.description,
 b.user_id, b.rating_status, b.point_name, b.max_point_name,
 b.point_value, b.max_point_value, b.is_passed
   FROM cds_slots a
   LEFT JOIN (SELECT * FROM cds_performance_appraisal_final_slots temp
   WHERE temp.root_id=? AND temp.user_id=?) b
   ON a.id = b.slot_id
   WHERE a.root_id = ? AND a.id NOT IN(SELECT c.slot_id
   		FROM cds_performance_appraisal_slots c
   		WHERE c.root_id = ? AND c.user_id = ? AND c.period_id = ?)
   ORDER BY a.number_order
           ]]>
	</sql>

	<sql id="FinalSlotsPassNotInPASlot">
        <![CDATA[
         SELECT a.id, a.level_id, a.root_id, a.name, a.description,
 b.user_id, b.rating_status, b.point_name, b.max_point_name,
 b.point_value, b.max_point_value, b.is_passed
   FROM cds_slots a
   JOIN (SELECT * FROM cds_performance_appraisal_final_slots temp
   WHERE temp.root_id=? AND temp.user_id=? AND temp.is_passed=true) b
   ON a.id = b.slot_id
   WHERE a.root_id = ? AND a.id NOT IN(SELECT c.slot_id
   		FROM cds_performance_appraisal_slots c
   		WHERE c.root_id = ? AND c.user_id = ? AND c.period_id = ?)
   ORDER BY a.number_order
           ]]>
	</sql>

	<sql id="FinalSlotsFailNotInPASlot">
        <![CDATA[
         SELECT a.id, a.level_id, a.root_id, a.name, a.description,
 b.user_id, b.rating_status, b.point_name, b.max_point_name,
 b.point_value, b.max_point_value, b.is_passed
   FROM cds_slots a
   JOIN (SELECT * FROM cds_performance_appraisal_final_slots temp
   WHERE temp.root_id=? AND temp.user_id=? AND temp.is_passed=false AND temp.rating_status=true) b
   ON a.id = b.slot_id
   WHERE a.root_id = ? AND a.id NOT IN(SELECT c.slot_id
   		FROM cds_performance_appraisal_slots c
   		WHERE c.root_id = ? AND c.user_id = ? AND c.period_id = ?)
   ORDER BY a.number_order
           ]]>
	</sql>

	<sql id="FinalSlotsNotStartNotInPASlot">
        <![CDATA[
         SELECT a.id, a.level_id, a.root_id, a.name, a.description,
 b.user_id, b.rating_status, b.point_name, b.max_point_name,
 b.point_value, b.max_point_value, b.is_passed
   FROM cds_slots a
   LEFT JOIN (SELECT * FROM cds_performance_appraisal_final_slots temp
   WHERE temp.root_id=? AND temp.user_id=? AND temp.rating_status=false) b
   ON a.id = b.slot_id
   WHERE a.root_id = ? AND a.id NOT IN
(SELECT d.slot_id FROM cds_performance_appraisal_final_slots d
   WHERE d.root_id=? AND d.user_id=?) AND a.id NOT IN(SELECT c.slot_id
   		FROM cds_performance_appraisal_slots c
   		WHERE c.root_id = ? AND c.user_id = ? AND c.period_id = ?)
   ORDER BY a.number_order
           ]]>
	</sql>

	<sql id="CdsPerformanceAppraisals">
        <![CDATA[
        SELECT *
   		FROM cds_performance_appraisals
   		WHERE user_id = ? AND period_id = ?
           ]]>
	</sql>

	<sql id="PASlotDetails">
        <![CDATA[
        SELECT *
   		FROM v_performance_appraisal_slots
   		WHERE user_id = ? AND period_id = ? AND slot_id = ?
           ]]>
	</sql>

	<sql id="PASlotComments">
        <![CDATA[
        SELECT *
   		FROM cds_performance_appraisal_slot_comments
   		WHERE user_id = ? AND period_id = ? AND slot_id = ?
           ]]>
	</sql>

	<sql id="PASlotsRatingByUser">
        <![CDATA[
        SELECT *
   		FROM cds_performance_appraisal_slots
   		WHERE user_id = ? AND period_id = ? AND rating_status = ?
           ]]>
	</sql>

	<sql id="PAEmployeesOfPM">
        <![CDATA[
        SELECT *
   		FROM v_employees_in_projects
   		WHERE period_id = ? AND org_id = ? AND rating_status_pm = ? AND user_id <> ?
   				AND rating_status <> 0
   		ORDER BY lastname, firstname ASC
           ]]>
	</sql>

	<sql id="AllPAEmployeesOfPM">
        <![CDATA[
        SELECT *
   		FROM v_employees_in_projects
   		WHERE period_id = ? AND org_id = ? AND user_id <> ? AND rating_status <> 0		
   		ORDER BY lastname, firstname ASC
           ]]>
	</sql>

	<sql id="AllPAEmployeesOfPMAllOrgStatus">
        <![CDATA[
       SELECT * 
	   FROM v_employees_in_projects
	   WHERE period_id = ? AND rating_status <> 0 AND org_id IN (SELECT org_id 
	   		FROM progate_organization_participants
			WHERE user_id = ? AND role_id = ?) AND rating_status_pm = ? AND user_id <> ?
	   ORDER BY lastname, firstname ASC
           ]]>
	</sql>

	<sql id="AllPAEmployeesOfPMAllOrg">
        <![CDATA[
       SELECT * 
	   FROM v_employees_in_projects
	   WHERE period_id = ? AND rating_status <> 0 AND org_id IN (SELECT org_id 
	   		FROM progate_organization_participants
			WHERE user_id = ? AND role_id = ?) AND user_id <> ?
	   ORDER BY lastname, firstname ASC
           ]]>
	</sql>

	<sql id="AllPAEmployeesOfBODAllOrgStatus">
        <![CDATA[
       SELECT ve.* 
	   FROM v_employees_in_projects ve
	   JOIN (SELECT user_id, MIN(begin_time) AS begin_time
	   		 FROM v_employees_in_projects
	   		 WHERE period_id = ? AND is_removed = false AND rating_status <> 0 AND org_id IN (SELECT o.id
										  		FROM (SELECT DISTINCT ur.org_id AS bod_id
													  FROM progate_organization_participants ur
													  WHERE ur.role_id = ?) AS o1
												JOIN organizations o ON o1.bod_id = o.bod_id
										  		WHERE o.root_id = ? AND o.id <> o1.bod_id) AND rating_status_bod = ?
			 GROUP BY user_id) AS temp ON ve.begin_time = temp.begin_time
	   WHERE ve.period_id = ?
	   ORDER BY ve.lastname, ve.firstname ASC
           ]]>
	</sql>

	<sql id="AllPAEmployeesOfBODAllOrg">
        <![CDATA[
       SELECT ve.* 
	   FROM v_employees_in_projects ve
	   JOIN (SELECT user_id, MIN(begin_time) AS begin_time
	   		 FROM v_employees_in_projects
	   		 WHERE period_id = ? AND is_removed = false AND rating_status <> 0 AND org_id IN (SELECT o.id
										  		FROM (SELECT DISTINCT ur.org_id AS bod_id
													  FROM progate_organization_participants ur
													  WHERE ur.role_id = ?) AS o1
												JOIN organizations o ON o1.bod_id = o.bod_id
										  		WHERE o.root_id = ? AND o.id <> o1.bod_id)
			 GROUP BY user_id) AS temp ON ve.begin_time = temp.begin_time
	   WHERE ve.period_id = ?
	   ORDER BY ve.lastname, ve.firstname ASC
           ]]>
	</sql>

	<sql id="AllPAEmployeesOfBODAllOrgStatusPM">
        <![CDATA[
       SELECT ve.* 
	   FROM v_employees_in_projects ve
	   JOIN (SELECT user_id, MIN(begin_time) AS begin_time
	   		 FROM v_employees_in_projects
	   		 WHERE period_id = ? AND is_removed = false AND org_id IN (SELECT o.id
										  		FROM (SELECT DISTINCT ur.org_id AS bod_id
													  FROM progate_organization_participants ur
													  WHERE ur.role_id = ?) AS o1
												JOIN organizations o ON o1.bod_id = o.bod_id
										  		WHERE o.root_id = ? AND o.id <> o1.bod_id) AND rating_status_bod = ? AND rating_status_pm = ?
			 GROUP BY user_id) AS temp ON ve.begin_time = temp.begin_time
	   WHERE ve.period_id = ?
	   ORDER BY ve.lastname, ve.firstname ASC
           ]]>
	</sql>

	<sql id="AllPAEmployeesOfBODAllOrgPM">
        <![CDATA[
       SELECT ve.* 
	   FROM v_employees_in_projects ve
	   JOIN (SELECT user_id, MIN(begin_time) AS begin_time
	   		 FROM v_employees_in_projects
	   		 WHERE period_id = ? AND is_removed = false AND org_id IN (SELECT o.id 
										  		FROM (SELECT DISTINCT ur.org_id AS bod_id
													  FROM progate_organization_participants ur
													  WHERE ur.role_id = ?) AS o1
												JOIN organizations o ON o1.bod_id = o.bod_id
										  		WHERE o.root_id = ? AND o.id <> o1.bod_id) AND rating_status_pm = ?
			 GROUP BY user_id) AS temp ON ve.begin_time = temp.begin_time
		WHERE ve.period_id = ?
	  	ORDER BY ve.lastname, ve.firstname ASC
           ]]>
	</sql>

	<sql id="PASlotsRatingByPM">
        <![CDATA[
       SELECT *
	   FROM cds_performance_appraisal_slots 
	   WHERE period_id = ? AND user_id = ? AND rating_status_pm != 0
           ]]>
	</sql>

	<sql id="PAEmployeesOfBOD">
        <![CDATA[
        SELECT *
   		FROM v_employees_in_projects
   		WHERE period_id = ? AND org_id = ? AND rating_status_bod = ?
   			AND rating_status <> 0
   		ORDER BY lastname, firstname ASC
           ]]>
	</sql>

	<sql id="AllPAEmployeesOfBOD">
        <![CDATA[
        SELECT *
   		FROM v_employees_in_projects
   		WHERE period_id = ? AND org_id = ? AND rating_status <> 0
   		ORDER BY lastname, firstname ASC
           ]]>
	</sql>

	<sql id="ApprovalOfBOD">
        <![CDATA[
        SELECT *
   		FROM v_employees_in_projects
   		WHERE period_id = ? AND org_id = ? AND rating_status_bod = ? AND rating_status_pm = ?
   		ORDER BY lastname, firstname ASC
           ]]>
	</sql>

	<sql id="AllApprovalOfBOD">
        <![CDATA[
        SELECT *
   		FROM v_employees_in_projects
   		WHERE period_id = ? AND org_id = ? AND rating_status_pm = ?
   		ORDER BY lastname, firstname ASC
           ]]>
	</sql>

	<sql id="ProjectsOfPM">
        <![CDATA[
       SELECT a.*
	   FROM organizations a
	   JOIN progate_organization_participants b ON a.id = b.org_id
	   WHERE a.root_id = ? AND b.user_id = ? AND b.role_id = ? AND a.org_status = TRUE 
           ]]>
	</sql>

	<sql id="ProjectsOfBOD">
        <![CDATA[
      SELECT o.* 
	  FROM (SELECT DISTINCT ur.org_id AS bod_id
			FROM progate_organization_participants ur
			WHERE ur.role_id = ?) AS o1
	  JOIN organizations o ON o1.bod_id = o.bod_id
	  WHERE o.root_id = ? AND o.id <> o1.bod_id AND org_status = TRUE
           ]]>
	</sql>

	<sql id="EmployeesSlotsRating">
        <![CDATA[
       SELECT *
	   FROM v_performance_appraisal_slots 
	   WHERE period_id = ? AND user_id = ?
	   ORDER BY competency_number_order, level_number_order, slot_number_order ASC
           ]]>
	</sql>

	<sql id="CheckEmployeeInOrg">
        <![CDATA[
       SELECT *
	   FROM v_employees_in_projects 
	   WHERE period_id = ? AND user_id = ? AND is_removed = false
           ]]>
	</sql>


	<sql id="SlotsStatisticalReport">
		<![CDATA[	
		SELECT cds_slots.id, cds_slots.root_id, cds_slots.level_id, cds_slots.name, cds_slots.description,
			j.period_id, j.user_id, j.pm_uid, j.firstname, j.lastname, j.rating_status_pm, j.rating_status_bod, j.point_name,
			j.point_value, j.max_point_name, j.max_point_value, j.to_date, j.status FROM cds_slots LEFT JOIN(
		SELECT i.period_id, i.slot_id, i.user_id, i.point_name, i.point_value, i.pm_uid, i.firstname, i.lastname,
			i.rating_status_pm, i.rating_status_bod,i.max_point_name, i.max_point_value, i.to_date, i.status FROM (
		SELECT g.period_id, g.slot_id, g.user_id, g.point_name, g.point_value,
			g.pm_uid, g.firstname, g.lastname, g.rating_status_pm, g.rating_status_bod,
			g.max_point_name, g.max_point_value, g.to_date, h.period_id AS status FROM (
		SELECT f.period_id, f.slot_id, f.user_id, f.point_name, f.point_value, f.pm_uid,
			user_.firstname, user_.lastname, f.rating_status_pm, f.rating_status_bod,
			f.max_point_name, f.max_point_value, f.to_date FROM (
		SELECT e.period_id, e.slot_id, e.user_id, e.point_name, e.point_value,
			e.pm_uid, e.rating_status_pm, e.rating_status_bod, e.max_point_name, e.max_point_value,e.to_date FROM (
		SELECT c.period_id, c.slot_id, c.user_id, c.point_name, c.point_value, c.pm_uid, c.rating_status_pm,
			c.rating_status_bod,c.max_point_name, c.max_point_value,d.to_date FROM cds_performance_appraisal_slots c JOIN (
			SELECT b.id, b.to_date FROM cds_evaluation_periods b
				WHERE b.status=3 AND b.to_date<=(SELECT a.to_date FROM cds_evaluation_periods a WHERE a.id=?))
				AS d ON c.period_id=d.id
			WHERE c.user_id=? AND c.root_id=?) AS e JOIN(
			SELECT e2.slot_id, e2.to_date FROM(
			SELECT slot_id, max(to_date) as to_date FROM (
			SELECT c1.slot_id,d1.to_date FROM cds_performance_appraisal_slots c1 JOIN (
				SELECT b1.id, b1.to_date FROM cds_evaluation_periods b1
				WHERE b1.status=3 AND b1.to_date<=(SELECT a1.to_date FROM cds_evaluation_periods a1 WHERE a1.id=?))
				AS d1 ON c1.period_id=d1.id
				WHERE c1.user_id=? AND c1.root_id=?) AS e1
				GROUP BY slot_id )AS e2 )AS e3
				ON e3.slot_id=e.slot_id AND e3.to_date=e.to_date) AS f
			LEFT JOIN user_ ON f.pm_uid=user_.userid ) AS g
			LEFT JOIN (SELECT slots.slot_id, slots.period_id FROM cds_performance_appraisal_slots slots
					WHERE slots.user_id=? AND slots.period_id=?) AS h ON g.slot_id=h.slot_id) AS i) AS j
			ON cds_slots.id=j.slot_id
			WHERE cds_slots.level_id=?
			ORDER BY cds_slots.number_order
		]]>
	</sql>

	<sql id="LevelStatisticalReport">
        <![CDATA[
       	SELECT h.id, h.root_id, h.competency_id, h.name, g.period_id, g.user_id, g.total_level_point
	FROM cds_levels h LEFT JOIN(
	SELECT f.period_id, f.level_id, f.user_id, f.total_level_point FROM (
	SELECT e.period_id, e.level_id, e.user_id, e.total_level_point, e .to_date FROM (
	SELECT c.period_id, c.level_id, c.user_id, c.total_level_point,
		d.to_date FROM cds_performance_appraisal_levels c JOIN (
		SELECT b.id, b.to_date FROM cds_evaluation_periods b
			WHERE b.status=3 AND b.to_date<=(SELECT a.to_date FROM cds_evaluation_periods a WHERE a.id=?))
			AS d ON c.period_id=d.id
			WHERE c.user_id=? AND c.root_id=?) AS e JOIN(
			SELECT e2.level_id, e2.to_date FROM(
			SELECT level_id, max(to_date) as to_date FROM (
			SELECT c1.level_id,d1.to_date FROM cds_performance_appraisal_levels c1 JOIN (
				SELECT b1.id, b1.to_date FROM cds_evaluation_periods b1
					WHERE b1.status=3 AND b1.to_date<=(SELECT a1.to_date FROM cds_evaluation_periods a1 WHERE a1.id=?))
					AS d1 ON c1.period_id=d1.id
					WHERE c1.user_id=? AND c1.root_id=?) AS e1
					GROUP BY level_id )AS e2 )AS e3
					ON e3.level_id=e.level_id AND e3.to_date=e.to_date) AS f) AS g
				ON h.id=g.level_id
				WHERE h.competency_id=?
				ORDER BY h.number_order
           ]]>
	</sql>

	<sql id="CompetencyStatisticalReport">
        <![CDATA[
       	SELECT h.id, h.root_id, h.name, g.period_id, g.user_id, g.level_ranking_hash, g.level_ranking_value
			FROM cds_competencies h LEFT JOIN(
		SELECT f.period_id, f.competency_id, f.user_id, f.level_ranking_hash, f.level_ranking_value FROM (
		SELECT e.period_id, e.competency_id, e.user_id, e.level_ranking_hash, e.level_ranking_value, e .to_date FROM (
		SELECT c.root_id, c.period_id, c.competency_id, c.user_id, c.level_ranking_hash, c.level_ranking_value,
			d.to_date FROM cds_performance_appraisal_competencies c JOIN (
		SELECT b.id, b.to_date FROM cds_evaluation_periods b
			WHERE b.status=3 AND b.to_date<=(SELECT a.to_date FROM cds_evaluation_periods a WHERE a.id=?))
			AS d ON c.period_id=d.id
			WHERE c.user_id=? AND c.root_id=?) AS e JOIN(
		SELECT e2.competency_id, e2.to_date FROM(
		SELECT competency_id, max(to_date) as to_date FROM (
		SELECT c1.competency_id,d1.to_date FROM cds_performance_appraisal_competencies c1 JOIN (
			SELECT b1.id, b1.to_date FROM cds_evaluation_periods b1
				WHERE b1.status=3 AND b1.to_date<=(SELECT a1.to_date FROM cds_evaluation_periods a1 WHERE a1.id=?))
				AS d1 ON c1.period_id=d1.id
				WHERE c1.user_id=? AND c1.root_id=?) AS e1
				GROUP BY competency_id )AS e2 )AS e3
				ON e3.competency_id=e.competency_id AND e3.to_date=e.to_date) AS f) AS g
			ON h.id=g.competency_id
			WHERE h.root_id=?
			ORDER BY h.number_order
           ]]>
	</sql>

	<sql id="ReportBasedOnCometencyId">
        <![CDATA[
       	SELECT h.id, h.root_id, h.name, g.period_id, g.user_id, g.level_ranking_hash, g.level_ranking_value
			FROM cds_competencies h LEFT JOIN(
		SELECT f.period_id, f.competency_id, f.user_id, f.level_ranking_hash, f.level_ranking_value FROM (
		SELECT e.period_id, e.competency_id, e.user_id, e.level_ranking_hash, e.level_ranking_value, e .to_date FROM (
		SELECT c.root_id, c.period_id, c.competency_id, c.user_id, c.level_ranking_hash, c.level_ranking_value,
			d.to_date FROM cds_performance_appraisal_competencies c JOIN (
		SELECT b.id, b.to_date FROM cds_evaluation_periods b
			WHERE b.status=3 AND b.to_date<=(SELECT a.to_date FROM cds_evaluation_periods a WHERE a.id=?))
			AS d ON c.period_id=d.id
			WHERE c.user_id=? AND c.root_id=?) AS e JOIN(
		SELECT e2.competency_id, e2.to_date FROM(
		SELECT competency_id, max(to_date) as to_date FROM (
		SELECT c1.competency_id,d1.to_date FROM cds_performance_appraisal_competencies c1 JOIN (
			SELECT b1.id, b1.to_date FROM cds_evaluation_periods b1
				WHERE b1.status=3 AND b1.to_date<=(SELECT a1.to_date FROM cds_evaluation_periods a1 WHERE a1.id=?))
				AS d1 ON c1.period_id=d1.id
				WHERE c1.user_id=? AND c1.root_id=?) AS e1
				GROUP BY competency_id )AS e2 )AS e3
				ON e3.competency_id=e.competency_id AND e3.to_date=e.to_date) AS f) AS g
			ON h.id=g.competency_id
			WHERE h.root_id=? AND h.id=?
           ]]>
	</sql>

	<sql id="StaffReport">
        <![CDATA[
			SELECT ve.* FROM v_employees_in_projects ve
				JOIN ( SELECT period_id, max(view_id) AS view_id FROM v_employees_in_projects
						WHERE user_id = ? AND root_id = ? AND period_status = 3
						GROUP BY period_id) AS temp
				ON ve.view_id = temp.view_id
				ORDER BY to_date ASC
           ]]>
	</sql>

	<sql id="LevelMappingReport">
        <![CDATA[
			SELECT ve.* FROM v_employees_in_projects ve
				JOIN ( SELECT period_id, max(view_id) AS view_id FROM v_employees_in_projects
						WHERE user_id = ? AND root_id = ? AND period_id = ?
						GROUP BY period_id) AS temp
				ON ve.view_id = temp.view_id
           ]]>
	</sql>

	<sql id="EmployeeInfoReport">
        <![CDATA[
		SELECT * FROM progate_organizations_staffs
   			WHERE root_id=? AND user_id=? AND is_removed=false
			ORDER BY begin_time
           ]]>
	</sql>

	<sql id="EmployeeInfoCDP">
        <![CDATA[
		SELECT * FROM v_employees_in_projects
			WHERE root_id = ? AND user_id = ? AND period_id = ?
			ORDER BY begin_time ASC
           ]]>
	</sql>

	<sql id="CdpInfo">
        <![CDATA[
		SELECT * FROM cds_cdp
			WHERE root_id = ? AND user_id = ? AND period_id = ?
			ORDER BY written_at ASC
           ]]>
	</sql>

	<sql id="UserInCompany">
        <![CDATA[
		SELECT * 
		FROM user_ u
		WHERE u.userid IN (SELECT user_id
							FROM progate_organizations_staffs
							WHERE is_removed = false AND root_id = ?
							GROUP BY user_id)
           ]]>
	</sql>

	<sql id="SpecialPermissions">
        <![CDATA[
		SELECT a.* 
		FROM progate_organizations_users_permissions a
		JOIN progate_permissions b ON a.per_id = b.id
		WHERE b.app_id = ? AND b.category = ? AND a.org_id = ? AND a.user_id = ? AND per_id LIKE ?
				AND a.is_grant = false
           ]]>
	</sql>

	<sql id="RolesPermissions">
        <![CDATA[
		SELECT * 
		FROM v_progate_permissions_roles
		WHERE app_id = ? AND category = ? AND role_id = ? AND per_id LIKE ?
           ]]>
	</sql>

	<sql id="LastRatingNotApproved">
        <![CDATA[
		SELECT *
  		FROM cds_performance_appraisal_slot_rating
  		WHERE period_id = ? AND user_id = ? AND slot_id = ? AND user_type = ?
  		ORDER BY rating_at DESC
  		LIMIT 1
           ]]>
	</sql>

	<sql id="SlotRatingHistory">
        <![CDATA[
		SELECT *
  		FROM cds_performance_appraisal_slot_rating
  		WHERE root_id = ? AND user_id = ? AND slot_id = ? 
  		ORDER BY rating_at DESC
           ]]>
	</sql>

	<sql id="EmployeesInPermissions">
        <![CDATA[
		SELECT a.*
  		FROM progate_organizations_staffs a
  		JOIN user_ b ON a.user_id = b.userid 
  		WHERE a.root_id = ? AND a.org_id = ? AND a.is_removed = false
  		ORDER BY b.lastname, b.firstname ASC
           ]]>
	</sql>

	<sql id="OrgsUsersPermission">
        <![CDATA[
		SELECT a.*
  		FROM progate_organizations_users_permissions a
  		JOIN progate_permissions b ON a.per_id = b.id 
  		WHERE a.org_id = ? AND a.user_id = ? AND b.app_id = ? AND b.category = ?
  		ORDER BY b.number_order
           ]]>
	</sql>

	<sql id="EmployeeStateReportInAllOrgOfPM">
        <![CDATA[
		 SELECT ve.* 
	   FROM v_employees_in_projects ve
	   JOIN (SELECT user_id, MIN(begin_time) AS begin_time
		FROM v_employees_in_projects
		WHERE period_id = ? AND org_id IN (
						SELECT DISTINCT org_id 
						FROM progate_organization_participants
						WHERE user_id = ? AND role_id = ?)
			AND begin_time < to_date
			 GROUP BY user_id) AS temp ON ve.begin_time = temp.begin_time
	   WHERE ve.period_id = ?
	   ORDER BY ve.lastname, ve.firstname ASC
           ]]>
	</sql>

	<sql id="EmployeeStateReportInOrgOfPMAndBOD">
        <![CDATA[
	    	SELECT ve1.*
			FROM v_employees_in_projects ve1
			WHERE period_id = ? AND org_id = ? AND begin_time < to_date
			ORDER BY lastname, firstname ASC
           ]]>
	</sql>

	<sql id="EmployeeStateReportInAllOrgOfBOD">
        <![CDATA[
	    SELECT ve.* 
	   FROM v_employees_in_projects ve
	   JOIN (SELECT user_id, MIN(begin_time) AS begin_time
	   		 FROM v_employees_in_projects
	   		 WHERE period_id = ? AND org_id IN (SELECT o.id
			FROM (SELECT DISTINCT ur.org_id AS bod_id
					FROM progate_organization_participants ur
					WHERE ur.role_id = ?) AS o1
			JOIN organizations o ON o1.bod_id = o.bod_id
			WHERE o.root_id = ? AND o.id <> o1.bod_id)
			 GROUP BY user_id) AS temp ON ve.begin_time = temp.begin_time
	   WHERE ve.period_id = ?
	   ORDER BY ve.lastname, ve.firstname ASC
           ]]>
	</sql>
	
	<sql id="ExistedLevel">
        <![CDATA[
		SELECT *
  		FROM cds_levels  
  		WHERE root_id = ? AND name LIKE ? AND competency_id = ?
           ]]>
	</sql>
	
	<sql id="ExistedSlot">
        <![CDATA[
		SELECT *
  		FROM cds_slots
  		WHERE root_id = ? AND name LIKE ? AND level_id = ?
           ]]>
	</sql>
	
	<sql id="AllPAEmployeesBODInCdpAllOrg">
        <![CDATA[
       SELECT ve.* 
	   FROM v_employees_in_projects ve
	   JOIN (SELECT user_id, MIN(begin_time) AS begin_time
	   		 FROM v_employees_in_projects
	   		 WHERE period_id = ? AND is_removed = false AND org_id IN (SELECT o.id
										  		FROM (SELECT DISTINCT ur.org_id AS bod_id
													  FROM progate_organization_participants ur
													  WHERE ur.role_id = ?) AS o1
												JOIN organizations o ON o1.bod_id = o.bod_id
										  		WHERE o.root_id = ? AND o.id <> o1.bod_id)
			 GROUP BY user_id) AS temp ON ve.begin_time = temp.begin_time
	   WHERE ve.period_id = ?
	   ORDER BY ve.lastname, ve.firstname ASC
           ]]>
	</sql>
	
	<sql id="AllPAEmployeesBODInCdp">
        <![CDATA[
        SELECT *
   		FROM v_employees_in_projects
   		WHERE period_id = ? AND org_id = ? AND is_removed = false
   		ORDER BY lastname, firstname ASC
           ]]>
	</sql>
	
	<sql id="AllPAEmployeesPMInCdpAllOrg">
        <![CDATA[
       SELECT * 
	   FROM v_employees_in_projects
	   WHERE period_id = ? AND org_id IN (SELECT org_id 
	   		FROM progate_organization_participants
			WHERE user_id = ? AND role_id = ?) AND user_id <> ?
	   ORDER BY lastname, firstname ASC
           ]]>
	</sql>
	
	<sql id="AllPAEmployeesPMInCdp">
        <![CDATA[
        SELECT *
   		FROM v_employees_in_projects
   		WHERE period_id = ? AND org_id = ? AND user_id <> ?
   		ORDER BY lastname, firstname ASC
           ]]>
	</sql>
	
	<sql id="BODInCompany">
        <![CDATA[
        SELECT a.*
		FROM progate_organizations_staffs a
		JOIN progate_organization_participants b ON a.org_id = b.org_id
		WHERE a.root_id = ? AND b.role_id = ?
           ]]>
	</sql>	
	
	<sql id="Company">
        <![CDATA[
        SELECT *
		FROM organizations 
		WHERE parent_id = 0;
           ]]>
	</sql>
		
	<sql id="ToDateOfPreviousPeriod">
        <![CDATA[
        SELECT * FROM cds_evaluation_periods
		WHERE root_id = (SELECT root_id FROM cds_evaluation_periods WHERE id = ?)
		and to_date < (SELECT from_date FROM cds_evaluation_periods WHERE id = ?)
		ORDER BY to_date DESC
		LIMIT 1
           ]]>
	</sql>
	
	<sql id="FromDateOfNextPeriod">
        <![CDATA[
        SELECT * FROM cds_evaluation_periods
		WHERE root_id = (SELECT root_id FROM cds_evaluation_periods WHERE id = ?)
		and from_date > (SELECT to_date FROM cds_evaluation_periods WHERE id = ?)
		ORDER BY to_date ASC
		LIMIT 1
           ]]>
	</sql>
</custom-sql>
